#!/usr/bin/env bash

set -eox pipefail

junit_output_file="./junit.output"
. bin/build_utils

WIREMOCK_HOST="tenant.cyberark.cloud"
WIREMOCK_SECRETSMGR_HOST="tenant.secretsmgr.cyberark.cloud"
RUNNER_NAME="conjur-cli-go-test-runner"
WIREMOCK_KEYSTORE_PASSWORD="$(openssl rand -base64 12)"

function main() {
  prepare_wire_mock_config
  build_docker_ut_image
  run_unit_tests
}

function build_docker_ut_image() {
  echo "Building unit test image..."
  docker build -f Dockerfile.test -t conjur-cli-go-test-runner:latest .
}

function cleanup() {
  docker container stop tinyproxy || true
  docker container rm tinyproxy || true
  docker container stop wiremock || true
  docker container rm wiremock || true
  docker network rm ip6net
  docker network rm ip4net
}

trap 'cleanup' EXIT

function prepare_wire_mock_config() {
  rm -f test/wiremock/localhost.pfx

  openssl req -x509 -nodes -days 365 \
    -newkey rsa:2048 \
    -keyout test/wiremock/localhost.key \
    -out test/wiremock/localhost.crt \
    -config test/wiremock/localhost.conf \
    -extensions v3_ca \
    -subj "/CN=${WIREMOCK_SECRETSMGR_HOST}"

  openssl pkcs12 -export \
    -out test/wiremock/localhost.pfx \
    -inkey test/wiremock/localhost.key \
    -in test/wiremock/localhost.crt \
    -passout "pass:${WIREMOCK_KEYSTORE_PASSWORD}"

  openssl pkcs12 -in test/wiremock/localhost.pfx \
    -passin "pass:${WIREMOCK_KEYSTORE_PASSWORD}" \
    -info -noout >/dev/null
}

function run_unit_tests() {
  echo "Creating ipv6 network..."
  docker network create --ipv6 --subnet 2001:0DB8::/112 ip6net
  docker network create ip4net
  echo "Starting WireMock container..."
  docker run -d \
             --name wiremock \
             --network ip4net \
             -p 8080:8080 \
              -p 443:443 \
              -v "$PWD/test/wiremock:/home/wiremock:rw" \
              wiremock/wiremock \
              --verbose \
              --port 8080 \
              --https-port 443 \
              --https-keystore /home/wiremock/localhost.pfx \
              --keystore-type PKCS12 \
              --keystore-password "${WIREMOCK_KEYSTORE_PASSWORD}" \
              --key-manager-password "${WIREMOCK_KEYSTORE_PASSWORD}"

  WIREMOCK_IP="$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' wiremock)"
  echo "WireMock IP: ${WIREMOCK_IP}"

  docker run -d \
    --name tinyproxy \
    --network ip4net \
    --add-host "${WIREMOCK_HOST}:${WIREMOCK_IP}" \
    --add-host "${WIREMOCK_SECRETSMGR_HOST}:${WIREMOCK_IP}" \
    -p 8888:8888 \
    vimagick/tinyproxy

  echo "Running unit tests..."
  set +e
  docker run --rm \
            --name "${RUNNER_NAME}" \
            --add-host "${WIREMOCK_HOST}:${WIREMOCK_IP}" \
            --add-host "${WIREMOCK_SECRETSMGR_HOST}:${WIREMOCK_IP}" \
            --network ip6net \
            --network ip4net \
             --volume "$PWD"/:/conjur-cli-go/test/ \
             conjur-cli-go-test-runner:latest \
             -coverprofile="./test/c.out.tmp" \
             ./... \
             | tee -a "$junit_output_file"

  test_result=$?
  cat c.out.tmp | grep -v "_dev.go" > c.out
  rm -f c.out.tmp
  echo "Unit test exit status: $test_result"
  set -e
  exit $test_result
}

main
